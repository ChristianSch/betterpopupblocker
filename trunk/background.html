<html>
<head>
<script src="common/port.js"></script>
<script src="common/config.js"></script>
<script src="background.js"></script>

<script type = "text/javascript">

	function fixRegularExpressions()
	{
		var currWhitelist = config.get('whitelist');
		for (var i=0; i < currWhitelist.length; i++)
		{	
			if (currWhitelist[i] == "^(http[s]?:\/\/[a-z0-9\._-]+\.|http[s]?:\/\/)google\.[a-z]+($|\/)")
			{
				currWhitelist[i] = "^(http[s]?:\\/\\/[a-z0-9\\._-]+\\.|http[s]?:\\/\\/)google\\.[a-z]+($|\\/)";
			}
			else if (currWhitelist[i] == "^(http[s]?:\/\/[a-z0-9\._-]+\.|http[s]?:\/\/)youtube\.[a-z]+($|\/)")
			{
				currWhitelist[i] = "^(http[s]?:\\/\\/[a-z0-9\\._-]+\\.|http[s]?:\\/\\/)youtube\\.[a-z]+($|\\/)";
			}
			else if (currWhitelist[i] == "^(http[s]?:\/\/[a-z0-9\._-]+\.|http[s]?:\/\/)pezcyclingnews\.[a-z]+($|\/)")
			{
				currWhitelist[i] = "^(http[s]?:\\/\\/[a-z0-9\\._-]+\\.|http[s]?:\\/\\/)pezcyclingnews\\.[a-z]+($|\\/)";
			}
		}
		config.set("whitelist", currWhitelist);
	}
	
	if (config.get('currVersion') < 100500000)
	{	
		// We used incorrectly escaped regular expressions in versions previous to 1.2 so we are trying
		// to fix the default ones here	
		if (config.get('currVersion') < 100200000)
		{
			fixRegularExpressions();
		}
		
		// We are now able to use the whitelist when closing pop ups from plugins like Flash so we re-enable it for everyone on first run.
		//config.set('closeAllPopUpWindows', true);
		
		config.set('currVersion', 100500000);
	}

	/*	// For browser action button
	config.set('globalAllowAll', false);
	
	// Show the current state of the plugin
	var initialState = config.get('globalAllowAll');
	if (initialState == true)
	{		
		chrome.browserAction.setBadgeText({text:String('off')});
		chrome.browserAction.setBadgeBackgroundColor({color:[0, 0, 0, 100]});		
	}
	else
	{
		chrome.browserAction.setBadgeText({text:String('on')});
		chrome.browserAction.setBadgeBackgroundColor({color:[0, 200, 0, 100]});		
	}
	*/
	
	config.set('globalAllowAll', false);
	config.set('tempList', new Array());	
	
	if (SAFARI)
	{
		safari.application.addEventListener("validate", validateCommand, false);
		safari.application.addEventListener("command", performCommand, false);	
	}
	else
	{
		chrome.tabs.onUpdated.addListener(function(tabid, changeinfo, tab) {
			if (config.get('showPageActionButton'))
			{
				var currState = config.get('globalAllowAll');
				if (currState || isWhitelisted(tab.url))
				{
					chrome.pageAction.setIcon({path: "IconAllowed.png", tabId: tab.id});
				}
				else
				{
					chrome.pageAction.setIcon({path: "IconForbidden.png", tabId: tab.id});
				}
				chrome.pageAction.show(tab.id);
			}
			else
			{
				chrome.pageAction.hide(tab.id);
			}
		});	
		
		
		chrome.windows.onCreated.addListener(
			function(wnd) {
				// valid values for type: normal, popup
				if (wnd.type === "popup" && config.get("globalAllowAll") !== true && config.get("closeAllPopUpWindows") === true)
					chrome.windows.remove(wnd.id);
				
			}
		);	
		
	}
		
</script>
</head>
</html>


